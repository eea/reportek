version: '2'

services:
  postgres:
    image: postgres:9.6
    env_file:
      - ./docker/postgres.env
    volumes:
      - pg-data:/var/lib/postgresql/data
      - pg-backups:/pg_backups

  rabbitmq:
    image: rabbitmq:3-management
    env_file:
      - ./docker/rabbitmq.env


  tusd:
    image: tusproject/tusd:latest
    env_file:
      - ./docker/demo.env
    entrypoint:
      - /go/bin/tusd
      - -dir
      - /srv/tusd-data
      - -hooks-http
      - http://app/api/${API_VERSION}/uploads/
    volumes:
      - tusd-uploads:/srv/tusd-data

  app:
    image: eeacms/reportek
    env_file:
      - ./docker/postgres.env
      - ./docker/demo.env
    volumes:
    - static-files:/var/local/reportek/reportek/static
    - tusd-uploads:/var/local/tusd_uploads
    depends_on:
      - postgres
      - rabbitmq
      - tusd
    labels:
      io.rancher.container.pull_image: always
      io.rancher.scheduler.affinity:host_label_ne: reserved=yes

  nginx:
    image: nginx:latest
    environment:
      NGINX_CONF: |-
        upstream app {
          ip_hash;
          server app:80;
        }
        server {
          listen 80;
          access_log /var/log/nginx/access.log main;
          location / {
            proxy_pass http://app/;
          }
          location /static {
            sendfile on;
            tcp_nopush on;
            gzip on;
            gzip_types text/plain application/x-javascript text/css;
            expires 1d;
            root /var/local/reportek/reportek;
          }
        }
    command: /bin/sh -c 'echo "$$NGINX_CONF" > /etc/nginx/conf.d/default.conf && exec nginx -g "daemon off;"'
    volumes:
    - static-files:/var/local/reportek/reportek/static:ro
    depends_on:
      - app

volumes:
  pg-data:
    driver: rancher-nfs
  pg-backups:
    driver: rancher-nfs
  tusd-uploads:
    driver: rancher-nfs
  static-files:
    driver: local
